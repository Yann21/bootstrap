---
- name: Provision production machine
  hosts: localhost

  tasks:
    - name: Run the equivalent of pacman -Syu
      become: yes
      community.general.pacman:
        update_cache: yes
        upgrade: yes
    

    - name: Install / synchronize reference files.
      tags: ho
      become: yes
      file:
        src: "{{ item }}"
        dest: "/etc/{{ item | basename }}"
        state: hard
        force: yes
      loop: "{{lookup('fileglob', 'ref/*.txt', wantlist=True)}}"


    - name: Install packages with pacman.
      become: yes
      community.general.pacman:
        name: "{{ item }}"
        state: present
      loop: "{{ lookup('file', 'ref/pkglist.txt').splitlines()}}"


    - name: Check if yay executable is already in path.
      shell: "which yay"
      register: yay_bool

    - name: Install yay.
      when: yay_bool.rc != 0
      block:
      - name: Create build directory.
        become: yes
        file:
          path: /tmp/yay-build
          state: directory
          owner: "{{ lookup('env', 'USER') }}"
          group: "{{ lookup('env', 'USER') }}"

      - name: Clone yay source repo.
        git:
          repo: https://aur.archlinux.org/yay-git.git
          dest: /tmp/yay-build

      - name: Make and install yay.
        shell: makepkg -si --noconfirm
        args:
          chdir: /tmp/yay-build

      - name: Remove build directory
        file:
          path: /tmp/yay-build
          state: absent

    - name: Install packages
      shell: yay -S --noconfirm --needed {{ item }}
      loop: "{{ lookup('file', 'ref/pkglistaur.txt').splitlines()}}"


    - name: Turn on systemd services.
      systemd:
        name: "{{ item }}"
        state: started
        scope: system # Default
      loop: "{{ lookup('file', 'ref/systemdlist.txt').splitlines()}}"

    - name: Turn on systemd user services.
      systemd:
        name: "{{ item }}"
        state: started
        scope: user
      loop: "{{ lookup('file', 'ref/systemduserlist.txt').splitlines()}}"



    #- name: Set up remote server
      #tags: debug
      #block:
        #- name: Clone dotfiles repository
          #git:
            #repo: https://github.com/Yann21/dotfiles.git
            #dest: ~/dotfiles_test

        #- name: Install dotfiles to user directory
          #shell: rcup -v

        #- name: TODO - Install vim plugins

    #- name: Fresh install
      #tags: debug
      #block:
        #- name: Install XMonad, XMobar
